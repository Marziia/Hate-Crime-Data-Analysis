---
title: "A history of reported hate crimes in Toronto"
subtitle: "Increased frequency poses risk to diversity"
author: 
  - Marzia Zaidi
thanks: "Code and data are available at: https://github.com/Marziia/Hate-Crime-Data-Analysis/tree/main."
date: today
date-format: long
abstract: "Upon studying the history of reported hate crimes in Toronto, we observe that there has been a sharp spike in 2023. We also observe that most of the hate crimes happen during the day, i.e. in broad daylight. Finally, we see that while most of the crims are reported almost instantaneously, there are some that take up to a day to repor."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
```

# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....

# Data {#sec-data}

Some of our data is of penguins (@fig-bills), from @palmerpenguins.

```{r}
library(opendatatoronto)
library(tidyverse)
library(dplyr)
nameOfDataSet <- "hate-crimes-open-data"
#### Download data ####
package <- show_package(nameOfDataSet)

# get all resources for this package
resources <- list_package_resources(nameOfDataSet)

# identify datastore resources; by default, Toronto Open Data sets datastore resource format to CSV for non-geospatial and GeoJSON for geospatial resources

datastore_resources <- filter(resources, tolower(format) %in% c('csv', 'geojson'))

# load the first datastore resource as a sample
data <- filter(datastore_resources, row_number()==1) %>% get_resource()

# first, we analyze if the number of crimes have increased over the years

# Convert the string years to integers
years_numeric <- as.integer(data$REPORTED_YEAR)

# Create a histogram of the years
hist(years_numeric, breaks = 7, col = "lightgrey", 
     main = "Histogram of Years",
     xlab = "Year",
     ylab = "Frequency")

# Looking at this, we can see that the trend was mostly non existent till 2022, and then in 2023, we had a spike in crimes.


```

Talk more about it.

And also planes (@fig-planes). (You can change the height and width, but don't worry about doing that until you have finished every other aspect of the paper - Quarto will try to make it look nice and the defaults usually work well once you have enough text.)

```{r}
# we want to analyze if the crimes happened at night
# Here is the vector of time integers
times <- data$OCCURRENCE_TIME

# Pad integers to ensure four digits (HHMM format)
times_padded <- sprintf("%04s", times)
print(times_padded)

# Extract hours and minutes
hours <- as.integer(substr(times_padded, 1, 2))  # First two characters are the hours
minutes <- as.integer(substr(times_padded, 3, 4))  # Last two characters are the minutes

# Convert to total minutes since midnight
total_minutes <- hours * 60 + minutes
print(total_minutes)

# Create a histogram of the total minutes since midnight
hist(total_minutes, breaks = 24, col = "lightblue", 
     main = "Histogram of Times (in minutes since midnight)",
     xlab = "Minutes since midnight",
     ylab = "Frequency")

# Convert total minutes to hours (fractional)
total_hours <- total_minutes / 60

# Create a histogram of the total hours since midnight
hist(total_hours, breaks = 24, col = "lightblue", 
     main = "Histogram of Times (in hours since midnight)",
     xlab = "Hours since midnight",
     ylab = "Frequency")

# we see most of these have been crimes during the day
```



```{r}
# analyze the time between a crime happening and the report
# Function to convert string integers to total minutes since midnight
convert_to_minutes <- function(time_strings) {
  # Pad the time strings to ensure four digits (HHMM format)
  times_padded <- sprintf("%04s", time_strings)
  
  # Extract hours and minutes
  hours <- as.integer(substr(times_padded, 1, 2))  # First two characters are hours
  minutes <- as.integer(substr(times_padded, 3, 4))  # Last two characters are minutes
  
  # Convert to total minutes since midnight
  total_minutes <- hours * 60 + minutes
  return(total_minutes)
}

# Convert both columns to minutes since midnight
time_start_minutes <- convert_to_minutes(data$OCCURRENCE_TIME)
time_end_minutes <- convert_to_minutes(data$REPORTED_TIME)


# Calculate time differences (end time - start time)
time_differences <- time_end_minutes - time_start_minutes

# Create a histogram of the time differences
hist(time_differences, breaks = 50, col = "red",
     main = "Histogram of Time Differences (in minutes)",
     xlab = "Time Difference (minutes)",
     ylab = "Frequency")

# most of the crimes were rerported very quickly, with some being reported the next day (corresponding to the negative portion of the distribution)
```

Talk way more about it.

# Model

The goal of our modelling strategy is to show that the number of crimes has increased over the years. We use a linear regression model to prove this]

## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.

### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.

# Results

Our results are summarized in @tbl-modelresults.

```{r}
data$OCCURRENCE_YEAR <- as.integer(data$OCCURRENCE_YEAR)
frequency_table <- table(data$OCCURRENCE_YEAR)
print(frequency_table)

```

```{r}
frequency_df <- as.data.frame(frequency_table)
colnames(frequency_df) <- c("Year_of_hate_crime", "frequency")
frequency_df$Year_of_hate_crime <- as.numeric(as.character(frequency_df$Year_of_hate_crime))
# Fit the linear regression model
model <- lm(frequency ~ Year_of_hate_crime, data = frequency_df)

# Print the summary of the model
summary(model)
# Load ggplot2
library(ggplot2)
ggplot(frequency_df, aes(x = Year_of_hate_crime, y = frequency)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Linear Regression of Frequency vs Year of Hate Crime",
       x = "Year of Hate crime",
       y = "Frequency")
```

# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this.

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {.unnumbered}

# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows...

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

pp_check(first_model) +
  theme_classic() +
  theme(legend.position = "bottom")

posterior_vs_prior(first_model) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom") +
  coord_flip()
```

## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

plot(first_model, "trace")

plot(first_model, "rhat")
```

\newpage

# References
